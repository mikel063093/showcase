<script>
    var login = "";
    var cancelar = "";
    var recuperar = "";
    $(document).ready(function (){

    hoverBotones("section.vistaPedido form.pedido div.contDer a.ingFacebook");
    hoverBotones("section.vistaPedido form.pedido div.contDer a.ingShowcase");
    hoverBotones("form.pedido div.contDer button");
    hoverBotones("section.vistaPedido .confirmacion a");
        {% if not app.request.isXmlHttpRequest %}
            removerClase('vistaPedido');

        {% endif %}
        obtenerModales();
        // Selector con el cual se hace el llamado a la ventana de cancelar pedido
        var $enlaceCancelar = $("section.vistaPedido form.pedido div.contDer a.cancelar");
        //Llama a la ventana modal
        $enlaceCancelar.click(function() {
            modalCancelar(cancelar);
            return false;
        });
        // Selector con el cual se hace el llamado a la ventana de iniciar sesion
        var $enlaceSesion = $("section.vistaPedido form.pedido div.contDer a.ingShowcase");
        //Llama a la ventana modal
        $enlaceSesion.click(function(e) {
            modalLogin(login);
            return false;
        });

        $('.menos').click(function (e) {
            e.preventDefault();
            let elemento = $(this);
            let contador = elemento.siblings('.cantidad');
            let cantidad = contador.text();

            if(cantidad > 0){
                contador.text(parseInt(cantidad) - 1);
                let unidades = elemento.parent().siblings('.informacion').children('#unidades');

                $.ajax({
                    type: "POST",
                    url: "{{ path('eliminarProductoCarritoWeb') }}",
                    dataType: "json",
                    data: {
                        idArticulo: elemento.attr('value'),
                        idCarrito: carrito,
                        cantidad:1
                    },
                    success: function (data){
                        if(data.estado){
                            $('#carrito').html(data.carro);
                            $('#lista').html(data.pedido);
                            mostrarMensaje(data.mensaje,'Exito');
                        }else{
                            mostrarMensaje(data.mensaje,'Fallo');
                        }
                        unidades.text(parseInt(cantidad) - 1);
                    }
                });
            }

        });

        $('.mas').click(function (e){
            e.preventDefault();
            let elemento = $(this);

            let contador = elemento.siblings('.cantidad');
            let cantidad = contador.text();

            contador.text( parseInt(cantidad) + 1);
            let unidades = elemento.parent().siblings('.informacion').children('#unidades');

            $.ajax({
                type: "POST",
                url: "{{ path('agregarProductoCarritoWeb') }}",
                dataType: "json",
                data: {
                    idArticulo: elemento.attr('value'),
                    idCarrito: carrito,
                    cantidad:1
                },
                success: function (data){
                    if(data.estado){
                        $('#carrito').html(data.carro);
                        $('#lista').html(data.pedido);
                        mostrarMensaje(data.mensaje,'Exito');
                    }else{
                        mostrarMensaje(data.mensaje,'Fallo');
                    }
                    unidades.text(parseInt(cantidad) + 1);
                }
            });


        });

        $("div.cupon input").keyup(function(e){
            var elemento = $(this);
            let codigo = elemento.val();
            if(codigo.length > 4){
                redimirCupon(elemento);
            }
            if(codigo.length == 0){
                elemento.removeAttr('class');
            }
        }).focusout(function(e){
            var elemento = $(this);
            if(codigo.length == 0){
                elemento.removeAttr('class');
            }else{
                redimirCupon(elemento);
            }
        });

        $('#pedido').validate({
            rules: {

                'numero': {  required: true  },
                'nomenclatura': {  required: true  },
                'casa': {  required: true  },
                {% if app.user is null %}
                'nombres' : { required: true},
                'apellidos' : { required: true},
                'email' : { required: true , email:true},
                'emailConfirm' : { required: true, equalTo: "#email" },
                'telefono' : { required: true},
                'password' : { required: true },
                {% endif %}
            },
            messages:{

                'numero': {  required: 'Este campo es obligatorio' },
                'nomenclatura': {  required: 'Este campo es obligatorio' },
                'casa': {  required: 'Este campo es obligatorio' },
                 {% if app.user is null %}
                'nombres' : { required: 'El campo Nombres es obligtorio'},
                'apellidos' : { required: 'El campo Apellidos es obligtorio'},
                'email' : { required: 'El campo Correo Electronico es obligtorio' , email: 'Este correo electronico no es valido '},
                'emailConfirm' : { equalTo: "Los correos no son iguales" },
                'telefono' : { required: 'El campo Telefono es obligtorio'},
                'password' : { required: 'El campo ContraseÃ±a es obligtorio' },
                {% endif %}
            },
            submitHandler: function(form) {
                enviar(form);
            },
            showErrors: function(errorMap, errorList) {
                if (errorList.length > 0) {
                }
            },
            invalidHandler: function(event, validator) {
                if (validator.errorList.length > 0) {
                    for (var i = 0; i < validator.errorList.length; i++) {
                        mostrarMensaje(validator.errorList[i].message,'Error');
                    };
                    return false;
                }
            },
            errorPlacement: function(error, element) {
                return false;
            }
        });
    });

    function redimirCupon(elemento){
        $.ajax({
            type: "POST",
            url: "{{ path('redimirCuponWeb') }}",
            dataType: "json",
            data:{
                codigo:elemento.val()
            },
            success: function (data) {
                elemento.removeAttr('class');
                if(data.estado) {
                    elemento.addClass('valido');
                }else{
                    mostrarMensaje(data.mensaje,'Fallo');
                    elemento.addClass('invalido');
                }
            }
        });
    }

    function obtenerModales(){
        $.ajax({
            type: "POST",
            url: "{{ path('obtenerLogin') }}",
            dataType: "json",

            success: function (data) {
                login = data.login;
            }
        });

        $.ajax({
            type: "POST",
            url: "{{ path('obtenerCancelar') }}",
            dataType: "json",

            success: function (data){
                cancelar = data.cancelar;
            }
        });

        $.ajax({
            type: "POST",
            url: "{{ path('obtenerRecuperar') }}",
            dataType: "json",

            success: function (data){
                recuperar = data.recuperar;

            }
        });
    };

    function enviar(form){

        var datos = $('#pedido').serialize();
        var errores = [];



        if($("#cupon").hasClass('invalido')){
            errores.push ( 'El cupon es invalido');
        }
        if($("#formaPago").val() == "vacio"){
            errores.push ( 'Debe seleccionar una forma de pago');
        }

        if(errores.length > 0){
            for (var i = 0; i < errores.length; i++) {
                mostrarMensaje(errores[i],'Error');
            };
            return false;
        }

        $.ajax({
            url:"{{path('realizarPedidoWeb')}}",
            type: 'post',
            dataType: 'json',
            data: datos,

            success: function (data){
                if(data.estado){

                    mostrarMensaje(data.mensaje,'Exito');
                    window.location.href = "{{ path('home') }}"
                }else{
                    mostrarMensaje(data.mensaje,'Error');
                    if(data.borrado){
                        window.location.href = "{{ path('home') }}"
                    }
                }


            }

        });

    }
</script>